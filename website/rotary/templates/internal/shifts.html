{% extends "base.html" %}
{% block title %} {{ g.strings.nav.index }} {% endblock%}

{% block content%}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('workers-container');
    const addWorkerBtn = document.getElementById('add-worker');
    const removeWorkerBtn = document.getElementById('remove-worker');
  
    addWorkerBtn.addEventListener('click', function () {
      // Clone the first worker selection box
      const newSelect = container.firstElementChild.cloneNode(true);
      // Append the cloned worker selection box to the container
      container.appendChild(newSelect);
    });
  
    removeWorkerBtn.addEventListener('click', function () {
      // Ensure there's more than one worker selection box before removing
      if (container.children.length > 1) {
        container.removeChild(container.lastElementChild);
      } else {
        alert('At least one worker must be selected.');
      }
    });
  });
</script>

<script type="text/javascript">
  let active_worker = {{ active_workers|tojson }};
  let all_worker = {{ all_workers|tojson }};
</script>

<script>
  document.addEventListener('DOMContentLoaded', () =>  {
    fetch('/internal/get_shifts')
    .then(response => response.json())
    .then(data => {
        window.data = data;  // Store data globally
        displayTable(data);
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const toggleAllWorkersCheckbox = document.getElementById('toggle-all-workers');
    const container = document.getElementById('workers-container');

    function updateWorkerSelectOptions() {
      const workersToUse = toggleAllWorkersCheckbox.checked ? all_worker : active_worker;
      const workerSelectContainers = container.querySelectorAll('.worker-select');
      workerSelectContainers.forEach(container => {
        const selectElement = container.querySelector('select[name="workerid[]"]');
        selectElement.innerHTML = ''; // Clear existing options
        // Add a default disabled option
        const defaultOption = document.createElement('option');
        defaultOption.value = "-1";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        defaultOption.textContent = "Select Worker";
        selectElement.appendChild(defaultOption);
        // Populate with new options
        workersToUse.forEach(worker => {
          const optionElement = document.createElement('option');
          optionElement.value = worker.id;
          optionElement.textContent = worker.display_name;
          selectElement.appendChild(optionElement);
        });
      });
    }

    // Update options when the checkbox state changes
    toggleAllWorkersCheckbox.addEventListener('change', updateWorkerSelectOptions);

    // Initial population based on the checkbox state
    updateWorkerSelectOptions();
  });
</script>
<div class="container mt-6 mb-6">
  
  <div class="box has-background">
    <label class="label">Add a shift</label>
    <p class="paragraph">Below you can add which people are working this shift. You can even add multiple people at once.</p>
    <form action="{{ request.path }}" method="POST">
      <div class="columns">
        <div class="column">
          <table class="table is-narrow has-background">
            <tr>
              <td>Date </td>
              <td> 
                <input name="date" type="date" value="{{ today }}" required>
              </td>
            </tr>
            <tr>
              <td>Start </td>
              <td>
                <input name="start" type="time" value="{{ default_start }}" required></td>
              </td>
            </tr>
            <tr>
              <td>End </td>
              <td> 
                <input name="end" type="time" value="{{ default_end }}" required></td>
              </td>
            <tr>
          </table>
        <button type="submit" formmethod="post" class="button is-link">Add shift </button>
        </div> <!-- End of column -->
        <div class="column" style="display: flex; flex-direction: column;">
          <table style="flex:1">
            <tr>
              <td colspan="3"> 
                <div id="workers-container">
                  <div class="worker-select" data-row-index="0">
                    <span class="select">
                      <select name="workerid[]" id="select-worker-shift-0">
                        <option value="-1" disabled selected>Select Worker</option> 
                        {% for worker in workers %}
                        <option value="{{ worker.id }}">{{ worker.display_name }}</option>
                        {% endfor %}
                      </select>
                    </span>
                    <span class="select" style="margin-left: 1em;"> 
                      <select name="shift_type[]">
                        {% for shift_type in shift_types %}
                        <option value="{{ shift_type.id }}">{{ shift_type.name }}</option>
                        {% endfor %}
                      </select>
                    </span>

                </div>
              </td>
            </tr>
          </table>
          <div style="margin-top:1em">
            <button type="button" id="add-worker" class="button is-link" style="margin-left:1em;">Add Worker</button>
            <button type="button" id="remove-worker" class="button is-danger" style="margin-left:1em;">Remove Worker</button>
            <span>
              <label for="toggle-all-workers">Show All Workers</label>
              <input type="checkbox" id="toggle-all-workers" class="toggle-workers-checkbox">
            </span>
          </div>
        </div> <!-- End of column -->
      </div>
    </form>
  </div>

<script>
  function displayTable(data) {
      const tableBody = document.getElementById('shifts-table').getElementsByTagName('tbody')[0];
      tableBody.innerHTML = '';
      data.forEach(shift => {
          const row = document.createElement('tr');
          row.innerHTML = `
          <td><p>${shift.date}</p></td>
          <td><p>${shift.start}</p></td>
          <td><p>${shift.end}</p></td>
          <td><p>${shift.worker}</p></td>
          <td><p>${shift.type}</p></td>
          <td>
            <form action='/internal/shifts/delete/${shift.id}' method="post">
              <button class="button is-danger is-small" type="submit">Delete</button>
            </form>
          </td>
          `;
          tableBody.appendChild(row);
      });
  }
  
  function filterTable() {
    const filterWorkerValue = document.getElementById('view-worker-shifts').value.toLowerCase();
    const filterStartValue = document.getElementById('view-start-shifts').value.toLowerCase() || "1980-01-01";
    const filterEndValue = document.getElementById('view-end-shifts').value.toLowerCase() || "4000-01-01";
    if (!filterWorkerValue && (!filterStartValue || !filterEndValue)) {
      return
    }
    const preFiltered = window.data.filter(shift => shift.worker.toLowerCase().includes(filterWorkerValue));
    const filteredData = preFiltered.filter(shift => shift.date > filterStartValue && shift.date < filterEndValue);
    displayTable(filteredData);
  }
</script>

  <div class="box has-background">
    <label class="label">Filter shifts</label>
    <p class="paragraph">In this box, you can select any combination of worker and timespan</p>
    <table class="table is-narrow has-background">
      <tr>
        <td>Worker</td>
        <td>
          <select id="view-worker-shifts" onchange="filterTable()">
            <option value="" disabled selected>Select Worker</option> 
            {% for worker in all_workers %}
            <option value="{{worker.display_name}}">{{worker.display_name}}</option>
            {% endfor %}
          </select>
        </td>
      </tr>
      <tr>
        <td>From</td>
        <td>
          <input id="view-start-shifts" type="date" onchange="filterTable()">
        </td>
      </tr>
      <tr>
        <td>To</td>
        <td>
          <input id="view-end-shifts" type="date" onchange="filterTable()">
        </td>
      </tr>
    </table>
  </div>

  <table id="shifts-table" class="table is-fullwidth">
    <thead>
      <tr>
        <th>Date</th>
        <th>Start</th>
        <th>End</th>
        <th>Worker</th>
        <th>Job</th>
        <th></th>
      <tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

{% endblock %}
